@model MeLink.Web.ViewModels.IncomingOrdersViewModel

@{
    ViewData["Title"] = "Incoming Orders";
}

<div class="container py-5">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-5">
        <div class="text-center text-md-start mb-3 mb-md-0">
            <h1 class="display-6 fw-bold text-dark">
                <i class="fas fa-inbox text-primary me-3"></i>
                Incoming Orders
            </h1>
            <p class="text-muted lead-sm">View and manage orders from your customers.</p>
        </div>
        <div>
            <a asp-controller="Supplier" asp-action="Index" class="btn btn-primary btn-lg rounded-pill px-4 shadow-sm">
                <i class="fas fa-truck-moving me-2"></i>
                Order from Suppliers
            </a>
        </div>
    </div>

    @if (Model.IncomingOrders.Any())
    {
        <div class="row g-4 mb-5">
            <div class="col-md-3">
                <div class="card h-100 border-primary bg-primary-subtle text-primary rounded-4 shadow-sm">
                    <div class="card-body text-center p-4">
                        <i class="fas fa-shopping-basket fa-2x mb-2 opacity-50"></i>
                        <h4 class="fw-bold mb-1">@Model.IncomingOrders.Count()</h4>
                        <small class="text-muted fw-semibold">Total Orders</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100 border-warning bg-warning-subtle text-warning rounded-4 shadow-sm">
                    <div class="card-body text-center p-4">
                        <i class="fas fa-clock fa-2x mb-2 opacity-50"></i>
                        <h4 class="fw-bold mb-1">@Model.IncomingOrders.Count(o => o.Status == "Pending")</h4>
                        <small class="text-muted fw-semibold">New Orders</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100 border-success bg-success-subtle text-success rounded-4 shadow-sm">
                    <div class="card-body text-center p-4">
                        <i class="fas fa-check-circle fa-2x mb-2 opacity-50"></i>
                        <h4 class="fw-bold mb-1">@Model.IncomingOrders.Count(o => o.Status == "Approved")</h4>
                        <small class="text-muted fw-semibold">Approved Orders</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card h-100 border-info bg-info-subtle text-info rounded-4 shadow-sm">
                    <div class="card-body text-center p-4">
                        <i class="fas fa-truck fa-2x mb-2 opacity-50"></i>
                        <h4 class="fw-bold mb-1">@Model.IncomingOrders.Count(o => o.Status == "Shipped")</h4>
                        <small class="text-muted fw-semibold">Shipped Orders</small>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4 rounded-4">
            <div class="card-body py-3">
                <div class="row align-items-center g-3">
                    <div class="col-md-6">
                        <div class="btn-group w-100" role="group" aria-label="Status filter">
                            <button type="button" class="btn btn-outline-secondary active" data-filter="all">All</button>
                            <button type="button" class="btn btn-outline-warning" data-filter="pending">Pending</button>
                            <button type="button" class="btn btn-outline-success" data-filter="approved">Approved</button>
                            <button type="button" class="btn btn-outline-danger" data-filter="rejected">Rejected</button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-white border-end-0 text-muted rounded-start-3"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control border-start-0 rounded-end-3" id="search-orders"
                                   placeholder="Search by customer name...">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row g-4" id="orders-container">
            @foreach (var order in Model.IncomingOrders.OrderByDescending(o => o.OrderDate))
            {
                <div class="col-lg-4 col-md-6 order-card"
                     data-status="@order.Status.ToLower()"
                     data-customer="@order.PharmacyName.ToLower()">

                    <div class="card h-100 shadow-sm border-0 rounded-4 order-item">
                        <div class="card-header @GetStatusHeaderClass(order.Status) text-white border-0 rounded-top-4 py-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <h6 class="mb-0 text-dark fw-bold">Order #@order.OrderId</h6>
                                <span class="badge bg-light text-dark px-3 py-2 rounded-pill">
                                    @Html.Raw(GetStatusIcon(order.Status)) @GetStatusText(order.Status)
                                </span>
                            </div>
                        </div>

                        <div class="card-body p-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <h6 class="mb-0 text-dark fw-bold">From: @order.PharmacyName</h6>
                                <small class="text-muted">
                                    <i class="fas fa-calendar-alt me-1"></i>
                                    @order.OrderDate.ToString("MMM dd, yyyy")
                                </small>
                            </div>
                            <small class="text-info fw-bold">
                                <i class="fas fa-pills me-1"></i>
                                @order.TotalItems item@(order.TotalItems > 1 ? "s" : "")
                            </small>

                            @if (order.Status == "Pending")
                            {
                                <div class="mt-3">
                                    <div class="progress rounded-pill" style="height: 8px;">
                                        <div class="progress-bar bg-warning"
                                             role="progressbar"
                                             style="width: 25%"
                                             aria-valuenow="25"
                                             aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                    <div class="text-muted small mt-1">Waiting for your confirmation</div>
                                </div>
                            }
                        </div>

                        <div class="card-footer bg-transparent border-0 pt-0 pb-3">
                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <a asp-action="Invoice" asp-route-orderId="@order.OrderId"
                                   class="btn btn-outline-primary rounded-pill flex-grow-1">
                                    <i class="fas fa-eye me-2"></i>
                                    View Details
                                </a>

                                @if (order.Status == "Pending")
                                {
                                    <button type="button"
                                            class="btn btn-outline-success rounded-pill flex-grow-1 approve-order-btn"
                                            data-order-id="@order.OrderId">
                                        <i class="fas fa-check me-2"></i>
                                        Approve
                                    </button>
                                    <button type="button"
                                            class="btn btn-outline-danger rounded-pill flex-grow-1 reject-order-btn"
                                            data-order-id="@order.OrderId">
                                        <i class="fas fa-times me-2"></i>
                                        Reject
                                    </button>
                                }
                                else if (order.Status == "Approved")
                                {
                                    <button type="button" class="btn btn-outline-info rounded-pill flex-grow-1 mark-shipped-btn" data-order-id="@order.OrderId">
                                        <i class="fas fa-shipping-fast me-2"></i>
                                        Mark as Shipped
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <div id="no-results" class="text-center py-5" style="display: none;">
            <div class="mb-4">
                <i class="fas fa-search text-muted opacity-25" style="font-size: 5rem;"></i>
            </div>
            <h4 class="text-muted fw-bold mb-2">No Orders Found</h4>
            <p class="text-muted lead-sm">Try adjusting your search or filter criteria.</p>
        </div>
    }
    else
    {
        <div class="text-center py-5">
            <div class="mb-4">
                <i class="fas fa-inbox text-muted opacity-25" style="font-size: 5rem;"></i>
            </div>
            <h4 class="text-muted fw-bold mb-3">No Incoming Orders</h4>
            <p class="text-muted mb-4 lead">
                You currently have no orders waiting for your action.
            </p>
        </div>
    }
</div>

@* Add Modals for Approve/Reject here if needed *@
@* This view will also need a similar JavaScript section to MyOrders.cshtml *@
@section Scripts {
    <script>
        $(document).ready(function () {

            // Filter functionality
            $('[data-filter]').on('click', function () {
                const filter = $(this).data('filter');

                // Update active button
                $('[data-filter]').removeClass('active');
                $(this).addClass('active');

                // Filter orders
                filterOrders(filter, $('#search-orders').val());
            });

            // Search functionality
            $('#search-orders').on('keyup', function () {
                const searchTerm = $(this).val();
                const activeFilter = $('[data-filter].active').data('filter');
                filterOrders(activeFilter, searchTerm);
            });

            // Handle Approve/Reject/Ship buttons (These functions need to be implemented in the controller)
            $('.approve-order-btn').on('click', function () {
                const orderId = $(this).data('order-id');
                if (confirm('Are you sure you want to approve this order?')) {
                    window.location.href = `/Order/ApproveOrder?orderId=${orderId}`;
                }
            });

            $('.reject-order-btn').on('click', function () {
                const orderId = $(this).data('order-id');
                if (confirm('Are you sure you want to reject this order?')) {
                    window.location.href = `/Order/RejectOrder?orderId=${orderId}`;
                }
            });

            $('.mark-shipped-btn').on('click', function () {
                const orderId = $(this).data('order-id');
                if (confirm('Mark this order as shipped?')) {
                    window.location.href = `/Order/MarkShipped?orderId=${orderId}`;
                }
            });

            function filterOrders(statusFilter, searchTerm) {
                let hasResults = false;

                $('.order-card').each(function () {
                    const orderStatus = $(this).data('status');
                    const customerName = $(this).data('customer');

                    let showOrder = true;

                    // Apply status filter
                    if (statusFilter !== 'all' && orderStatus !== statusFilter) {
                        showOrder = false;
                    }

                    // Apply search filter
                    if (searchTerm && !customerName.includes(searchTerm.toLowerCase())) {
                        showOrder = false;
                    }

                    if (showOrder) {
                        $(this).fadeIn(300);
                        hasResults = true;
                    } else {
                        $(this).fadeOut(300);
                    }
                });

                if (hasResults) {
                    $('#no-results').fadeOut(300);
                } else {
                    $('#no-results').fadeIn(300);
                }
            }

        });
    </script>
}

@functions {
    string GetStatusHeaderClass(string status)
    {
        return status switch
        {
            "Pending" => "bg-warning-subtle text-dark",
            "Approved" => "bg-primary-subtle text-dark",
            "Shipped" => "bg-info-subtle text-dark",
            "Delivered" => "bg-success",
            "Cancelled" => "bg-secondary",
            "Rejected" => "bg-danger",
            _ => "bg-dark"
        };
    }

    string GetStatusText(string status)
    {
        return status switch
        {
            "Pending" => "Pending Review",
            "Approved" => "Approved",
            "Shipped" => "In Transit",
            "Delivered" => "Delivered",
            "Cancelled" => "Cancelled",
            "Rejected" => "Rejected",
            _ => "Unknown"
        };
    }

    string GetStatusIcon(string status)
    {
        return status switch
        {
            "Pending" => "<i class='fas fa-clock'></i>",
            "Approved" => "<i class='fas fa-check'></i>",
            "Shipped" => "<i class='fas fa-shipping-fast'></i>",
            "Delivered" => "<i class='fas fa-check-circle'></i>",
            "Cancelled" => "<i class='fas fa-times'></i>",
            "Rejected" => "<i class='fas fa-times-circle'></i>",
            _ => "<i class='fas fa-question'></i>"
        };
    }
}