@model List<MeLink.Web.ViewModels.OrderSummaryViewModel>

@using Microsoft.AspNetCore.Mvc.Localization
@inject IViewLocalizer Localizer

@{
    ViewData["Title"] = Localizer["My Orders"];
}

<div class="container py-5">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 fw-bold text-dark">@Localizer["My Orders"]</h1>
            <p class="text-muted">@Localizer["Keep track of orders and their information."]</p>
        </div>
        <div class="d-flex gap-2">
            <a asp-action="Index" class="btn btn-primary rounded-3">
                <i class="fas fa-plus me-2"></i>@Localizer["Create Order"]
            </a>
        </div>
    </div>

    @if (Model.Any())
    {
        <div class="row g-4 mb-4">
            <div class="col-sm-6 col-md-3">
                <div class="card h-100 bg-primary-subtle text-primary rounded-4 shadow-sm">
                    <div class="card-body text-center p-4">
                        <p class="text-muted mb-1 small">@Localizer["Total Orders"]</p>
                        <h3 class="fw-bold mb-0">@Model.Count()</h3>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-md-3">
                <div class="card h-100 bg-warning-subtle text-primary rounded-4 shadow-sm">
                    <div class="card-body text-center p-4">
                        <p class="text-muted mb-1 small">@Localizer["Pending Orders"]</p>
                        <h3 class="fw-bold mb-0">@Model.Count(o => o.Status == "Pending")</h3>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-md-3">
                <div class="card h-100 bg-success-subtle text-primary rounded-4 shadow-sm">
                    <div class="card-body text-center p-4">
                        <p class="text-muted mb-1 small">@Localizer["Delivered Orders"]</p>
                        <h3 class="fw-bold mb-0">@Model.Count(o => o.Status == "Delivered")</h3>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-md-3">
                <div class="card h-100 bg-info-subtle text-primary rounded-4 shadow-sm">
                    <div class="card-body text-center p-4">
                        <p class="text-muted mb-1 small">@Localizer["Total Items Ordered"]</p>
                        <h3 class="fw-bold mb-0">@Model.Sum(o => o.TotalItems)</h3>
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="card shadow-sm border-0 rounded-4">
        <div class="card-header bg-white border-0 pt-4 pb-3 px-4">
            <div class="row justify-content-between align-items-center g-2">
                <div class="col-md-4">
                    <h5 class="fw-bold mb-0">@Localizer["Orders List"]</h5>
                </div>
                <div class="col-md-8 d-flex justify-content-start justify-content-md-end gap-2">
                    <div class="input-group" style="max-width: 300px;">
                        <span class="input-group-text bg-light border-0"><i class="fas fa-search"></i></span>
                        <input type="text" class="form-control bg-light border-0" id="search-orders" placeholder="@Localizer["Search orders..."]">
                    </div>
                    <div class="btn-group">
                        <button type="button" class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-filter me-2"></i> @Localizer["Filters"]
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" data-filter="all">@Localizer["All"]</a></li>
                            <li><a class="dropdown-item" href="#" data-filter="pending">@Localizer["Pending"]</a></li>
                            <li><a class="dropdown-item" href="#" data-filter="delivered">@Localizer["Delivered"]</a></li>
                            <li><a class="dropdown-item" href="#" data-filter="cancelled">@Localizer["Cancelled"]</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table orders-table mb-0">
                        <thead>
                            <tr>
                                <th>@Localizer["Order ID"]</th>
                                <th>@Localizer["Source Name"]</th>
                                <th>@Localizer["Order Date"]</th>
                                <th>@Localizer["Quantity"]</th>
                                <th>@Localizer["Order Status"]</th>
                                <th class="text-end">@Localizer["Action"]</th>
                            </tr>
                        </thead>
                        <tbody id="orders-container">
                            @foreach (var order in Model.OrderByDescending(o => o.OrderDate))
                            {
                                <tr data-status="@order.Status.ToLower()" data-pharmacy="@order.PharmacyName.ToLower()">
                                    <td><span class="fw-bold">#@order.OrderId</span></td>
                                    <td>@order.PharmacyName</td>
                                    <td>
                                        <small class="text-muted">
                                            <i class="fas fa-calendar-alt me-1"></i>
                                            @order.OrderDate.ToString("MMM dd, yyyy")
                                        </small>
                                    </td>
                                    <td>
                                        <small class="fw-bold">
                                            <i class="fas fa-pills me-1"></i>
                                            @order.TotalItems item@(order.TotalItems > 1 ? "s" : "")
                                        </small>
                                    </td>
                                    <td>
                                        <span class="badge @GetStatusBadgeClass(order.Status)">@GetStatusText(order.Status)</span>
                                    </td>
                                    <td class="text-end">
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-light" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                <i class="fas fa-ellipsis-v"></i>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-end">
                                                <li>
                                                    <a class="dropdown-item" asp-action="Invoice" asp-route-orderId="@order.OrderId">
                                                        <i class="fas fa-eye fa-fw me-2"></i>@Localizer["View Details"]
                                                    </a>
                                                </li>
                                                @if (order.Status == "Pending")
                                                {
                                                    <li>
                                                        <a class="dropdown-item text-danger cancel-order-btn" href="#" data-order-id="@order.OrderId" data-pharmacy="@order.PharmacyName">
                                                            <i class="fas fa-times fa-fw me-2"></i>@Localizer["Cancel Order"]
                                                        </a>
                                                    </li>
                                                }
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <div class="mb-4"><i class="fas fa-clipboard-list text-muted opacity-25" style="font-size: 5rem;"></i></div>
                    <h4 class="text-muted fw-bold mb-3">@Localizer["No Orders Yet"]</h4>
                    <p class="text-muted mb-4 lead">@Localizer["Start by searching for the medicines you need."]</p>
                </div>
            }
        </div>
    </div>
</div>

<div class="modal fade" id="cancelOrderModal" tabindex="-1" aria-labelledby="cancelOrderModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content rounded-4 shadow-lg">
            <div class="modal-header bg-danger text-white border-0 rounded-top-4">
                <h5 class="modal-title" id="cancelOrderModalLabel"><i class="fas fa-exclamation-triangle me-2"></i>@Localizer["Cancel Order"]</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4 text-center">
                <div class="mb-3"><i class="fas fa-question-circle fa-4x text-warning"></i></div>
                <h5 class="fw-bold mb-3">@Localizer["Are you sure you want to cancel this order?"]</h5>
                <p class="text-muted lead-sm mb-4">@Localizer["This action cannot be undone."]</p>
                <div class="alert alert-info rounded-3 text-start">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-info-circle me-2 fs-5"></i>
                        <div>
                            <strong class="text-dark">@Localizer["Order Details:"]</strong><br>
                            <span id="cancel-order-details" class="small"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer d-flex justify-content-center border-0 p-4">
                <button type="button" class="btn btn-secondary rounded-pill me-3" data-bs-dismiss="modal"><i class="fas fa-arrow-left me-2"></i>@Localizer["Keep Order"]</button>
                <form id="cancel-order-form" asp-action="CancelOrder" method="post" style="display: inline;">
                    <input type="hidden" name="orderId" id="cancel-order-id">
                    <button type="submit" class="btn btn-danger rounded-pill"><i class="fas fa-times me-2"></i>@Localizer["Yes, Cancel Order"]</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            $('.dropdown-item[data-filter]').on('click', function (e) {
                e.preventDefault();
                filterOrders($(this).data('filter'), $('#search-orders').val());
            });

            $('#search-orders').on('keyup', function () {
                const activeFilter = $('.dropdown-item.active').data('filter') || 'all';
                filterOrders(activeFilter, $(this).val());
            });

            function filterOrders(statusFilter, searchTerm) {
                $('#orders-container tr').each(function () {
                    const orderStatus = $(this).data('status');
                    const pharmacyName = $(this).data('pharmacy');
                    let showOrder = true;
                    if (statusFilter !== 'all' && orderStatus !== statusFilter) { showOrder = false; }
                    if (searchTerm && !pharmacyName.toLowerCase().includes(searchTerm.toLowerCase())) { showOrder = false; }
                    if (showOrder) { $(this).show(); }
                    else { $(this).hide(); }
                });
            }

            $('#orders-container').on('click', '.cancel-order-btn', function (e) {
                e.preventDefault();
                const orderId = $(this).data('order-id');
                const pharmacyName = $(this).data('pharmacy');
                $('#cancel-order-id').val(orderId);
                $('#cancel-order-details').text(`Order #${orderId} from ${pharmacyName}`);
                $('#cancelOrderModal').modal('show');
            });
        });
    </script>

    <style>
        .rounded-4 {
            border-radius: 1.5rem !important;
        }

        .bg-primary-subtle {
            background-color: #e0f2fe !important;
        }

        .bg-info-subtle {
            background-color: #cff4fc !important;
        }

        .bg-success-subtle {
            background-color: #d1e7dd !important;
        }

        .bg-warning-subtle {
            background-color: #fff3cd !important;
        }

        .orders-table {
            width: 100%;
            border-collapse: collapse;
            vertical-align: middle;
        }

            .orders-table thead th {
                text-transform: uppercase;
                color: #6c757d;
                font-size: 0.8rem;
                font-weight: 600;
                padding: 1rem 1.5rem;
                border-bottom: 1px solid #e9ecef;
                text-align: left;
            }

            .orders-table tbody td {
                padding: 1rem 1.5rem;
                border-top: 1px solid #e9ecef;
                color: #212529;
                text-align: left;
            }

            .orders-table .badge {
                padding: 0.4em 0.8em;
                border-radius: 6px;
                font-weight: 500;
                font-size: 0.8rem;
            }

        .badge.status-delivered {
            background-color: #ecfdf3;
            color: #027a48;
        }

        .badge.status-shipped, .badge.status-approved {
            background-color: #eff8ff;
            color: #175cd3;
        }

        .badge.status-pending {
            background-color: #e1c676;
            color: #b54708;
        }

        .badge.status-cancelled, .badge.status-rejected {
            background-color: #c17878;
            color: #b42318;
        }

        .badge.status-unknown {
            background-color: #f8f9fc;
            color: #364254;
        }

        /* === NEW: Hover effect for table rows === */
        .orders-table tbody tr {
            transition: background-color 0.2s ease-in-out;
        }

            .orders-table tbody tr:hover {
                background-color: #f8f9fa; /* A subtle light grey */
            }
    </style>
}

@functions {
    string GetStatusBadgeClass(string status) => "status-" + (status ?? "unknown").ToLower();

    string GetStatusText(string status) => (status ?? "").ToLower() switch
    {
        "pending" => "Pending",
        "approved" => "Approved",
        "shipped" => "Shipped",
        "delivered" => "Delivered",
        "cancelled" => "Cancelled",
        "rejected" => "Rejected",
        _ => "Unknown"
    };
}